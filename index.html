<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Highway to Continuous Integration</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen.css">
	<link rel="stylesheet" href="styles/style.css">
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-55877254-1', 'auto');
		ga('send', 'pageview');
	</script>
</head>
<body class="list">
	<header class="caption">
		<h1>Highway to Continuous Integration</h1>
		<p><a href="https://dentrifonov.github.io">Denis Trifonov</a>, <a href="http://2gis.ru">2GIS</a></p>
	</header>
	<section class="slide cover" id="cover"><div>
		<h2>Highway to Continuous Integration</h2>
		<p>Denis Trifonov, 2GIS</p>
		<img src="pictures/highload-cover.jpg">
		<style>
			#cover h2, #cover p {
				margin-left: -50px;
			}
			#cover img {
				height: 100%;
			}
		</style>
	</div></section>
	<section class="slide"><div>
		<h2>Обо мне</h2>
		<p>Тестировщик в командах Web API и Continuous Delivery.<br>Занимаюсь внедрением Continuous Integration и Continuous Delivery.</p>
	</div></section>
	<section class="slide"><div>
		<h2>Проблемы</h2>
		<ul>
			<li class="next">Выпуск новой задачи с багами</li>
			<li class="next">Негативное влияние новой задачи на другие компоненты</li>
			<li class="next">Неожиданности под нагрузкой или на боевом окружении</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Последствия</h2>
		<ul>
			<li>Повторный цикл выпуска задачи</li>
			<li>Негативные фидбеки</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Почему?</h2>
		<ul>
			<li>Не проверили задачу</li>
			<li>Не проверили продукт целиком</li>
			<li>Не проверили на предбоевом контуре</li>
			<li>Не проверили производительность</li>
			<li>Торопились [ хотфиксить ]</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Цель</h2>
		<p>Выявлять проблемы на этапе разработки задачи и интеграции.</p>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>Continuous Integration is a software development practice where members of a team integrate their work frequently, usually each person integrates at least daily - leading to multiple integrations per day. Each integration is verified by an automated build (including test) to detect integration errors as quickly as possible.</p>
			</blockquote>
			<figcaption>Martin Fowler</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>Ключевые моменты в CI</h2>
		<ul>
			<li>Наличие автотестов</li>
			<li>Автоматизированное разворачивание приложений и тестов</li>
			<li>Быстрое выполнение интеграционной сборки (до 10 минут)</li>
			<li>Тестирование на production-like окружении</li>
			<li>Работоспособность мастер-ветки и системы в приоритете</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Continuous Integration в 2GIS Web API</h2>
	</div></section>
	<section class="slide"><div>
		<h2>2GIS Web API</h2>
		<ul>
			<li>Версии 1.3 и 2.0</li>
			<li>7 приложений + Core на Yii Framework (PHP)</li>
			<li>Деплой приложений с помощью Phing и Chef</li>
			<li>Функциональные и юнит-тесты на 2GIS Framework (PHP)</li>
			<li>Деплой тестов с помощью Chef</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Что нужно?</h2>
		<ol>
			<li>CI-сервер</li>
			<li>Интеграционная сборка</li>
			<li>Регрессионная сборка</li>
			<li>Нагрузочная сборка</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>CI-сервер</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Задачи CI-сервера</h2>
		<ul>
			<li>Получение исходного кода</li>
			<li>Сборка проектов</li>
			<li>Выполнение тестов</li>
			<li>Формирование отчетов</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Решения CI-серверов</h2>
		<ul>
			<li>Atlassian Bamboo</li>
			<li>Jenkins</li>
			<li>JetBrains TeamCity</li>
			<li>GitLab</li>
			<li>Travis</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Выбор CI-сервера</h2>
		<ul>Jenkins:
			<li>Open Source</li>
			<li>Бесплатно</li>
			<li>Различные плагины</li>
			<li class="next">Просто уже был настроен</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<ol>
			<li><b>CI-сервер</b></li>
			<li>Интеграционная сборка</li>
			<li>Регрессионная сборка</li>
			<li>Нагрузочная сборка</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Интеграционная сборка</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Цель интеграционной сборки</h2>
		<p>Проверить, что задача сделана без багов.</p>
	</div></section>
	<section class="slide"><div>
		<h2>Git Flow</h2>
		<ul>
			<li>Все новые задачи и тесты в отдельной ветке</li>
			<li>Общая ветка разработки</li>
			<li>Стабильная мастер-ветка</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Этапы интеграционной сборки</h2>
		<ol>
			<li>Деплой окружения, приложений и тестов</li>
			<li>Выполнение тестов</li>
			<li>Слияние веток</li>
			<li class="next">Отметка тикетов в JIRA</li>
		</ol>
	</div></section>
	<!--<section class="slide"><div>-->
		<!--<h2>Обновление окружения</h2>-->
		<!--<pre>-->
			<!--<code>def update(issue, ...):-->
  <!--if hostname is not None and username is not None:-->
    <!--env.host_string = '%s@%s' % (username, hostname)-->
    <!--updater = WebAPICodeUpdated(issue, remote_mode=True)-->
  <!--else:-->
    <!--updater = WebAPICodeUpdated(issue, remote_mode=False)-->
			<!--</code>-->
		<!--</pre>-->
	<!--</div></section>-->
	<section class="slide"><div>
		<h2>Деплой окружения и приложений</h2>
		<ul>
			<li>Мелкие правки с помощью Phing (только приложения)</li>
			<li>Большие правки с помощью Chef (приложения + окружение)</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Пример (Python)</h2>
		<pre>
			<code>def update(<mark>issue</mark>, ...):
  if <mark>full_mode == 'yes'</mark>:
    updater.update()
  else:
    updater.fast_update()
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Выполнение тестов</h2>
		<ol>
			<li>Юнит-тесты</li>
			<li>Приоритетные функциональные тесты</li>
		</ol>
	</div></section>
	<section class="slide shout"><div>
		<h2>10 минут</h2>
	</div></section>
	<section class="slide"><div>
		<h2>ParaTest</h2>
		<p>
			<a href="https://github.com/brianium/paratest">github.com/brianium/paratest</a><br>
			Поддержка параллельного тестирования.
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Пример</h2>
		<pre>
			<code>$ paratest <mark>-p 8</mark> <mark class="important">-f</mark> \
	--phpunit ./phpunit \
	-c ./phpunit.xml \
	./tests</code>
		</pre>
	</div></section>
	<section class="slide shout"><div>
		<h2>1 минута<br>(16 ядер)</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Интеграция с JIRA</h2>
		<ul>
			<li>Комментарий к задаче об автоматическом мерже</li>
			<li>Метка у задачи с веткой master</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>JIRA REST API Client</h2>
		<p>
			<a href="https://github.com/chobie/jira-api-restclient">github.com/chobie/jira-api-restclient</a><br>
			PHP API-клиент для JIRA.
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Пример (PHP)</h2>
		<pre>
			<code>$client-><mark>addComment</mark>($jiraIssue, $jiraComment);

$client-><mark>editIssue</mark>($jiraIssue, [
  'fields' => ['labels' => $labels]
]);</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Итого</h2>
		<pre>
			<code><mark>New Branch</mark> -&gt; <mark>Deploy</mark> -&gt; <mark>Tests</mark> -&gt; <mark>Merge</mark> -&gt; <mark>Mark Issue</mark>
<mark class="comment">&lt;-----------------  Integration Build  -----------------&gt;</mark>
			</code>
		</pre>
	</div></section>
	<section class="slide shout"><div>
		<h2>1,5&ndash;2 минуты</h2>
	</div></section>
	<section class="slide"><div>
		<ol>
			<li><b>CI-сервер</b></li>
			<li><b>Интеграционная сборка</b></li>
			<li>Регрессионная сборка</li>
			<li>Нагрузочная сборка</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Регрессионная сборка</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Цели</h2>
		<ul>
			<li>Нет дефектов после мержа</li>
			<li>Стабильная мастер-ветка</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Этапы</h2>
		<ol>
			<li>Деплой окружения, приложений и тестов</li>
			<li>Выполнение всех тестов</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Итого</h2>
		<pre>
			<code><mark>RC</mark> -&gt; <mark>Deploy</mark> -&gt; <mark>Tests</mark> -&gt; <mark>Merge</mark> -&gt; <mark>Mark Issues</mark>
<mark class="comment">&lt;--------------  Regression Build  --------------&gt;</mark>
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<ol>
			<li><b>CI-сервер</b></li>
			<li><b>Интеграционная сборка</b></li>
			<li><b>Регрессионная сборка</b></li>
			<li>Нагрузочная сборка</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Нагрузочная сборка</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Цели</h2>
		<ul>
			<li>Код работает под нагрузкой</li>
			<li>Производительность не пострадала</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Этапы</h2>
		<ul>
			<li>Подготовить логи</li>
			<li>Выполнение нагрузки</li>
			<li>Анализ и сохранение результатов</li>
			<li>Решение</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Подготовка свежих логов</h2>
		<pre>
			<code>'rubric' => [
  '_base' => <mark>'request:\/2.0\/catalog\/rubric\/*'</mark>,
  'get' => [
    '_base' => <mark>'request:\/2.0\/catalog\/rubric\/get*'</mark>,
    'get' => [
      'query' => <mark>'_exists_:http_get_id'</mark>,
      'time' => 30
    ...
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Автоматизация и параметризация запуска</h2>
		<pre>
			<code>[phantom]
address={ADDRESS}:{PORT}
rps_schedule=line(1, {RPS}, 20) const({RPS}, {TIME})
[graphite]
address=graphite.test
prefix={GRAPHITE_PREFIX}
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Автоматизация и параметризация запуска</h2>
		<pre>
			<code>$nagruzhator = new DGTankist($options);
$nagruzhator->setLoadApiKey($LOAD_API_KEY);
$nagruzhator->setMethodsParams($methodsParams);
$nagruzhator->run();
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Мониторинг времени ответа</h2>
		<pre>
			<code>$url = '/render?from=12:00_20141031&until=12:15_20141031' .
  '&target=webapi.cumulative.quantiles.95_0&<mark>format=json</mark>';
...
if ($responseTime <= $expectedResponseTime) {
  $result['status'] = 'Success';
} else {
  $result['status'] = 'Fail';
}
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Построение графиков</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Публикация и хранение отчетов</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Итого</h2>
		<pre>
			<code><mark>Staging</mark> -&gt; <mark>Load Testing</mark> -&gt; <mark>Reports</mark> -&gt; <mark class="important">Release</mark>
<mark class="comment">&lt;-------  Load Testing Build  ------&gt;</mark>
			</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Результат</h2>
		<ul>
			<li>Интеграционная и регрессионная сборки выявляют проблемы</li>
			<li>Следим за производительностью</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Вывод</h2>
		<p>Чтобы выявлять баги и проблемы производительности на этапе разработки мы используем Continuous Integration.</p>
	</div></section>
	<section class="slide shout"><div>
		<h2>Что дальше?</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Continuous Delivery</h2>
		<pre>
			<code><mark class="important">CI</mark> -&gt; <mark>Staging</mark> -&gt; <mark>Performance</mark> -&gt; <mark>Release</mark>
			</code>
		</pre>
	</div></section>
	<section class="slide" id="cd"><div>
		<h2>Continuous Delivery или волшебная кнопка для релизов по запросу</h2>
		<p>Денис Яковлев, 2GIS</p>
		<p>Тезисы: <a href="http://www.highload.ru/2014/abstracts/1605.html">highload.ru/2014/abstracts/1605.html</a></p>
	</div></section>
	<section class="slide"><div>
		<h2>Благодарю за внимание!</h2>
		<p>
			Highway to Continuous Integration<br>
			<a href="https://dentrifonov.github.io/highway-to-ci">dentrifonov.github.io/highway-to-ci</a>
		</p>
		<p>
			Денис Трифонов, Специалист по тестированию ПО, 2GIS<br>
			de.trifonov@2gis.ru
		</p>
	</div></section>
	<div class="progress"><div></div></div>
	<script src="node_modules/shower-core/shower.min.js"></script>
	<script type="text/javascript">
		(function (d, w, c) {
			(w[c] = w[c] || []).push(function() {
				try {
					w.yaCounter26725989 = new Ya.Metrika({
						id:26725989
					});
				} catch(e) { }
			});
			var n = d.getElementsByTagName("script")[0],
					s = d.createElement("script"),
					f = function () { n.parentNode.insertBefore(s, n); };
			s.type = "text/javascript";
			s.async = true;
			s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
			if (w.opera == "[object Opera]") {
				d.addEventListener("DOMContentLoaded", f, false);
			} else { f(); }
		})(document, window, "yandex_metrika_callbacks");
	</script>
	<noscript><div><img src="//mc.yandex.ru/watch/26725989" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</body>
</html>