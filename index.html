<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Highway to Continuous Integration</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="node_modules/shower-ribbon/styles/screen.css">
	<link rel="stylesheet" href="styles/style.css">
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-55877254-1', 'auto');
		ga('send', 'pageview');
	</script>
</head>
<body class="list">
	<header class="caption">
		<h1>Highway to Continuous Integration</h1>
		<p><a href="https://dentrifonov.github.io">Denis Trifonov</a>, <a href="http://2gis.ru">2GIS</a></p>
	</header>
	<section class="slide cover"><div>
		<h2>Highway to Continuous Integration</h2>
		<p>Denis Trifonov, 2GIS</p>
	</div></section>
	<section class="slide"><div>
		<h2>Обо мне</h2>
		<p>Тестировщик в команде Continuous Delivery, ранее в Web API.</p>
	</div></section>
	<section class="slide"><div>
		<h2><a href="http://api.2gis.ru">api.2gis.ru</a></h2>
		<ul>
			<li>Справочник компаний</li>
			<li>Геоданные</li>
			<li>Карты</li>
			<li>Транспорт (скоро)</li>
			<li>Отзывы (скоро)</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Разработка справочного API</h2>
		<ul>
			<li>Версии 1.3 и 2.0</li>
			<li>7 приложений + Core на Yii Framework (PHP)</li>
			<li>Функциональные и юнит-тесты</li>
			<li>Git Flow</li>
			<li>Еженедельные релизы</li>
			<li>20 смежных команд</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Проблемы при разработке</h2>
		<ul>
			<li>Разработчики коммитят бажный код</li>
			<li>Тестировщики не находят баги или не успевают проверить фичу</li>
			<li>Узнаем о багах при подготовке релиза</li>
			<li>Релиз затягивается или переносится</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Мы узнаем о баге спустя 5 дней</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Continuous Integration</h2>
		<p>Не решит всех проблем разработки, но позволит выявлять баги на этапе программирования фичи и ее интеграции.</p>
	</div></section>
	<section class="slide cover"><div>
		<h2>Continuous Integration в 2GIS Web API</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Что у нас есть</h2>
		<ul>
			<li>Ветка с новой фичей</li>
			<li>Тесты</li>
			<li>Рецепты</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Интеграционная сборка</h2>
		<ol>
			<li>Развернуть новую ветку с помощью рецептов</li>
			<li>Прогнать все тесты
				<ul>
					<li>Все хорошо &mdash; смержить ветку в мастер</li>
					<li>Что-то упало &mdash; сообщить о проблеме</li>
				</ul>
			</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Можно использовать, но...</h2>
		<p>Сборка выполняется 6 часов, тесты занимают 99,9% времени.</p>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>6 часов это много для интеграции. Сборка не успевает за разработчиками. К тому же разработчики теряют контекст задачи, переходя к другой. <b>Нужно уложиться в 5 минут.</b></p>
			</blockquote>
			<figcaption>Тимлид Кирилл</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>ParaTest</h2>
		<p>
			<a href="https://github.com/brianium/paratest">github.com/brianium/paratest</a><br>
			Поддержка параллельного выполнения тестов на PHPUnit.
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Пример</h2>
		<pre>
			<code>$ paratest <mark>-p 8</mark> --phpunit ./phpunit \
  -c ./phpunit.xml ./tests</code>
		</pre>
	</div></section>
	<section class="slide shout"><div>
		<h2>50 минут<br>(16 ядер)</h2>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>А давайте для интеграционной сборки оставим <b>только приоритетные тесты</b>, которые покроют продукт в целом, а вечером будем гонять регрессию (все тесты)?</p>
			</blockquote>
			<figcaption>Тестировщица Настя</figcaption>
		</figure>
	</div></section>
	<section class="slide shout"><div>
		<h2>3 минуты</h2>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>Переразворачивать полностью окружение избыточно когда правки только в приложении.</p>
			</blockquote>
			<figcaption>Программист Игорь</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>Деплой окружения и приложений</h2>
		<ul>
			<li>Мелкие правки с помощью Phing (только приложения)</li>
			<li>Большие правки с помощью Chef (приложения + окружение)</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Пример (Python)</h2>
		<pre>
			<code>def update(<mark>issue</mark>, ...):
  if <mark>full_mode == 'yes'</mark>:
    updater.update()
  else:
    updater.fast_update()</code>
		</pre>
	</div></section>
	<section class="slide shout"><div>
		<h2>1,5&ndash;3 минуты</h2>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>Круто! А можно еще чтобы сборка сама как-нибудь в JIRA писала информацию по веткам и ставила метки?</p>
			</blockquote>
			<figcaption>Тестировщица Ира</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>Интеграция с JIRA</h2>
		<ul>
			<li>Комментарий в тикете об автоматическом мерже</li>
			<li>Метка у тикета с веткой master</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>JIRA REST API Client</h2>
		<p>
			<a href="https://github.com/chobie/jira-api-restclient">github.com/chobie/jira-api-restclient</a><br>
			API-клиент для JIRA на PHP.
		</p>
	</div></section>
	<section class="slide"><div>
		<h2>Пример (PHP)</h2>
		<pre>
			<code>$client-><mark>addComment</mark>($jiraIssue, $jiraComment);

$client-><mark>editIssue</mark>($jiraIssue, [
  'fields' => ['labels' => $labels]
]);</code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Интеграционная сборка в работе</h2>
		<pre>
			<code><mark>Feature Branch</mark> -&gt; <mark>Deploy</mark> -&gt; <mark>Priority Tests</mark>
  -&gt; <mark>Merge to Master</mark> -&gt; <mark>Mark Issue in JIRA</mark></code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Профит</h2>
		<p>Быстрое решение об интеграции новой фичи.</p>
	</div></section>
	<section class="slide"><div>
		<h2>Регрессия по расписанию</h2>
		<pre>
			<code><mark>Master Branch</mark> -&gt; <mark>Deploy</mark> -&gt; <mark class="important">Full Tests</mark></code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Профит</h2>
		<p>Стабильный мастер.</p>
	</div></section>
	<section class="slide"><div>
		<h2>Регрессия перед релизом</h2>
		<pre>
			<code><mark>Master Branch</mark> -&gt; <mark>RC</mark> -&gt; <mark>Deploy</mark> -&gt; <mark class="important">Full Tests</mark>
  -&gt; <mark>Merge to Stable</mark> -&gt; <mark>Mark Issues in JIRA</mark></code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Профит</h2>
		<p>Готовность релизиться.</p>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>В последнем релизе упала миграция на бою, хотя регрессия прошла успешно. Дело в том, что в сборке по расписанию миграция записалась в лог, после этого ее правили разработчики, а при подготовке релиза эта миграция пропустилась и не выполнилась. <b>Нужно перед регрессией полностью восстанавливать исходное состояние окружения.</b></p>
			</blockquote>
			<figcaption>Релиз-мастер Денис</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>Куда поместить окружение</h2>
		<ul>
			<li>Virtual Box</li>
			<li><b>Open Stack</b></li>
			<li>VMware</li>
			<li>Docker</li>
			<li>Другие</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Разворачивание Open Stack</h2>
		<ul>
			<li>Установить на железные ноды</li>
			<li>Минимально сконфигурировать (Controller + Compute)</li>
			<li>Написать шаблоны для деплоя сервисов</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Пример шаблона</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Готовое приватное облако</h2>
		<ul>
			<li>WebAPI-нода</li>
			<li>Нода с тестами</li>
			<li>Любая нода по требованию за 1 минуту</li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Обновленная регрессия</h2>
		<pre>
			<code><mark>...</mark> -&gt; <mark class="important">Revert VM</mark> -&gt; <mark>Deploy</mark> -&gt; <mark>...</mark> -&gt; <mark class="important">Update Snapshot</mark></code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Профит</h2>
		<p>Обновляем также как на бою: накатываем на последний stable.</p>
	</div></section>
	<section class="slide"><div>
		<figure>
			<blockquote>
				<p>Начал настраивать рабочее место и вылетели ошибки во время разворачивания API.</p>
			</blockquote>
			<figcaption>Новый программист Сережа</figcaption>
		</figure>
	</div></section>
	<section class="slide"><div>
		<h2>Сборка с нуля</h2>
		<pre>
			<code><mark>VM Up</mark> -&gt; <mark>Deploy</mark> -&gt; <mark>Import Data</mark> -&gt; <mark>Tests</mark> -&gt; <mark>VM Destroy</mark></code>
		</pre>
	</div></section>
	<section class="slide"><div>
		<h2>Профит</h2>
		<p>В любое время продукт развернется без ошибок.</p>
	</div></section>
	<section class="slide"><div>
		<h2>Итого</h2>
		<ol>
			<li>Интеграционная сборка</li>
			<li>Регрессионная сборка два раза в день</li>
			<li>Регрессионная сборка перед релизом</li>
			<li>Сборка с нуля</li>
		</ol>
	</div></section>
	<section class="slide"><div>
		<h2>Время обнаружения проблемы<br>от 1,5 минут до 4 часов</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Результат</h2>
		<ul>
			<li>Сборки падают, а значит выполняют свои задачи</li>
			<li>Время обнаружения проблемы от 1,5 минут до 4 часов</li>
			<li><b>Ежедневные релизы</b></li>
		</ul>
	</div></section>
	<section class="slide"><div>
		<h2>Вывод</h2>
		<p>Continuous Integration помогает выявлять баги на этапе программирования фичи и ее интеграции.</p>
	</div></section>
	<section class="slide shout"><div>
		<h2>Что дальше?</h2>
	</div></section>
	<section class="slide"><div>
		<h2>Continuous Delivery</h2>
		<pre>
			<code><mark class="important">CI</mark> -&gt; <mark>Additional Steps</mark> -&gt; <mark>Release</mark>
			</code>
		</pre>
	</div></section>
	<section class="slide" id="cd"><div>
		<h2>Continuous Delivery или волшебная кнопка для релизов по запросу</h2>
		<p>Денис Яковлев, 2GIS</p>
		<p>Тезисы: <a href="http://www.highload.ru/2014/abstracts/1605.html">highload.ru/2014/abstracts/1605.html</a></p>
	</div></section>
	<section class="slide"><div>
		<h2>Благодарю за внимание!</h2>
		<p>
			Highway to Continuous Integration<br>
			<a href="https://dentrifonov.github.io/highway-to-ci">dentrifonov.github.io/highway-to-ci</a>
		</p>
		<p>
			Денис Трифонов, Специалист по тестированию ПО, 2GIS<br>
			de.trifonov@2gis.ru
		</p>
	</div></section>
	<div class="progress"><div></div></div>
	<script src="node_modules/shower-core/shower.min.js"></script>
	<script type="text/javascript">
		(function (d, w, c) {
			(w[c] = w[c] || []).push(function() {
				try {
					w.yaCounter26725989 = new Ya.Metrika({
						id:26725989
					});
				} catch(e) { }
			});
			var n = d.getElementsByTagName("script")[0],
					s = d.createElement("script"),
					f = function () { n.parentNode.insertBefore(s, n); };
			s.type = "text/javascript";
			s.async = true;
			s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
			if (w.opera == "[object Opera]") {
				d.addEventListener("DOMContentLoaded", f, false);
			} else { f(); }
		})(document, window, "yandex_metrika_callbacks");
	</script>
	<noscript><div><img src="//mc.yandex.ru/watch/26725989" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</body>
</html>